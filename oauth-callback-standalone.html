<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluesky OAuth Callback</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 2rem;
            background-color: #f8fafc;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        .spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            color: #dc2626;
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .success {
            color: #059669;
            background-color: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        button {
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #2563eb;
        }

        .details {
            background-color: #f8fafc;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            font-family: monospace;
            font-size: 0.875rem;
            text-align: left;
            overflow-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading">
            <div class="spinner"></div>
            <h2>Processing authentication...</h2>
            <p>Please wait while we complete your Bluesky login.</p>
        </div>

        <div id="error" style="display: none;">
            <h2>Authentication Error</h2>
            <div class="error">
                <p id="error-message"></p>
                <p id="error-details"></p>
            </div>
            <button onclick="goHome()">Return to Home</button>
        </div>

        <div id="success" style="display: none;">
            <h2>Authentication Successful!</h2>
            <div class="success">
                <p>You have been successfully authenticated with Bluesky.</p>
            </div>
            <button onclick="goHome()">Continue to App</button>
        </div>
    </div>

    <script>
        // OAuth utilities for standalone callback
        const AUTH_STORAGE_KEY = 'bluesky_oauth_session';
        const CODE_VERIFIER_KEY = 'bluesky_code_verifier';
        const STATE_KEY = 'bluesky_oauth_state';
        const SERVER_URL_KEY = 'bluesky_server_url';

        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error');
        const successEl = document.getElementById('success');
        const errorMessageEl = document.getElementById('error-message');
        const errorDetailsEl = document.getElementById('error-details');

        // Make goHome function globally available
        window.goHome = function() {
            // Handle subdirectory structure
            const path = window.location.pathname;
            const basePath = path.includes('/bluesky-list-manager') ? '/bluesky-list-manager' : '';
            window.location.href = basePath + '/';
        };

        function base64UrlEncode(buffer) {
            const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));
            return base64
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }

        async function generateDpopKeypair() {
            return await crypto.subtle.generateKey(
                {
                    name: 'ECDSA',
                    namedCurve: 'P-256'
                },
                true,
                ['sign', 'verify']
            );
        }

        async function createDpopJwt(keypair, method, url, nonce, accessToken) {
            try {
                const publicKeyJwk = await crypto.subtle.exportKey('jwk', keypair.publicKey);

                const payload = {
                    jti: crypto.randomUUID(),
                    htm: method,
                    htu: url,
                    iat: Math.floor(Date.now() / 1000),
                    exp: Math.floor(Date.now() / 1000) + 120
                };

                if (nonce) {
                    payload.nonce = nonce;
                }

                if (accessToken) {
                    const encoder = new TextEncoder();
                    const data = encoder.encode(accessToken);
                    const hash = await crypto.subtle.digest('SHA-256', data);
                    payload.ath = base64UrlEncode(hash);
                }

                const header = {
                    alg: 'ES256',
                    typ: 'dpop+jwt',
                    jwk: {
                        kty: publicKeyJwk.kty,
                        crv: publicKeyJwk.crv,
                        x: publicKeyJwk.x,
                        y: publicKeyJwk.y
                    }
                };

                // Encode header and payload
                const headerB64 = btoa(JSON.stringify(header))
                    .replace(/\+/g, '-')
                    .replace(/\//g, '_')
                    .replace(/=+$/, '');
                const payloadB64 = btoa(JSON.stringify(payload))
                    .replace(/\+/g, '-')
                    .replace(/\//g, '_')
                    .replace(/=+$/, '');

                // Create the data to sign
                const dataToSign = `${headerB64}.${payloadB64}`;
                const encoder = new TextEncoder();
                const data = encoder.encode(dataToSign);

                // Sign the data
                const signature = await crypto.subtle.sign(
                    {
                        name: 'ECDSA',
                        hash: { name: 'SHA-256' }
                    },
                    keypair.privateKey,
                    data
                );

                // Encode the signature
                const signatureB64 = base64UrlEncode(signature);

                // Return the complete JWT
                return `${dataToSign}.${signatureB64}`;

            } catch (error) {
                console.error('Error creating DPoP JWT:', error);
                throw error;
            }
        }

        async function handleOAuthCallback(queryParams) {
            try {
                // 1. Verify state parameter
                const storedState = localStorage.getItem(STATE_KEY);
                const returnedState = queryParams.get('state');

                if (!storedState || storedState !== returnedState) {
                    throw new Error('Invalid state parameter');
                }

                // 2. Get the authorization code
                const code = queryParams.get('code');
                if (!code) {
                    throw new Error('No authorization code returned');
                }

                // 3. Get the code verifier from storage
                const codeVerifier = localStorage.getItem(CODE_VERIFIER_KEY);
                if (!codeVerifier) {
                    throw new Error('No code verifier found');
                }

                // 4. Get the server URL
                const serverUrl = localStorage.getItem(SERVER_URL_KEY) || 'https://bsky.social';

                // 5. Generate a new DPoP keypair
                const dpopKeypair = await generateDpopKeypair();

                // 6. Create a DPoP JWT for the token request
                const tokenEndpoint = `${serverUrl}/oauth/token`;
                const dpopJwt = await createDpopJwt(
                    dpopKeypair,
                    'POST',
                    tokenEndpoint
                );

                // 7. Exchange the code for tokens
                const clientId = 'https://pixeline.be/bluesky-list-manager/.well-known/oauth-client-metadata.json';
                const path = window.location.pathname;
                const basePath = path.includes('/bluesky-list-manager') ? '/bluesky-list-manager' : '';
                const redirectUri = `${window.location.origin}${basePath}/oauth-callback-standalone.html`;

                const tokenRequestBody = new URLSearchParams({
                    grant_type: 'authorization_code',
                    code,
                    redirect_uri: redirectUri,
                    client_id: clientId,
                    code_verifier: codeVerifier
                });

                const tokenResponse = await fetch(tokenEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'DPoP': dpopJwt
                    },
                    body: tokenRequestBody
                });

                if (!tokenResponse.ok) {
                    let errorMsg = 'Token request failed';
                    try {
                        const errorData = await tokenResponse.json();
                        errorMsg += `: ${errorData.error}`;
                        if (errorData.error_description) {
                            errorMsg += ` - ${errorData.error_description}`;
                        }
                    } catch (e) {
                        console.error('Failed to parse error response', e);
                    }
                    throw new Error(errorMsg);
                }

                // 8. Parse the token response
                const tokenData = await tokenResponse.json();

                return {
                    accessToken: tokenData.access_token,
                    refreshToken: tokenData.refresh_token,
                    sub: tokenData.sub,
                    dpopKeypair,
                    serverNonce: tokenResponse.headers.get('DPoP-Nonce')
                };

            } catch (error) {
                console.error('OAuth callback error:', error);
                throw error;
            }
        }

        function storeOAuthSession(session) {
            localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify({
                accessToken: session.accessToken,
                refreshToken: session.refreshToken,
                sub: session.sub,
                serverNonce: session.serverNonce,
                timestamp: Date.now()
            }));
        }

        async function processCallback() {
            try {
                // Get query parameters from URL
                const urlParams = new URLSearchParams(window.location.search);

                // Check for error response from auth server
                if (urlParams.has('error')) {
                    const error = urlParams.get('error');
                    const errorDescription = urlParams.get('error_description');

                    errorMessageEl.textContent = `Error: ${error}`;
                    if (errorDescription) {
                        errorDetailsEl.textContent = decodeURIComponent(errorDescription);
                    }

                    loadingEl.style.display = 'none';
                    errorEl.style.display = 'block';
                    return;
                }

                // Handle the OAuth callback
                const session = await handleOAuthCallback(urlParams);

                // Store the session
                storeOAuthSession(session);

                // Show success message
                loadingEl.style.display = 'none';
                successEl.style.display = 'block';

                // Redirect to home page after a short delay
                setTimeout(() => {
                    const path = window.location.pathname;
                    const basePath = path.includes('/bluesky-list-manager') ? '/bluesky-list-manager' : '';
                    window.location.href = basePath + '/';
                }, 2000);

            } catch (error) {
                console.error('OAuth callback error:', error);

                errorMessageEl.textContent = error.message || 'An unknown error occurred';
                errorDetailsEl.textContent = error.stack || '';

                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
            }
        }

        // Start processing when page loads
        processCallback();
    </script>
</body>
</html>